name: CloudFlare

# Trigger the workflow when:
on:
  # A push occurs to one of the matched branches.
  push:
    branches: [master]
  # Or when a pull request event occurs for a pull request against one of the
  # matched branches.
  pull_request:
    branches: [master]

jobs:
  publish:
    # This name appears in GitHub's Checks API.
    name: publish
    # Do not trigger job for dependency update bot.
    if: github.actor != 'renovate[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Add Comment to PR
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ## Deploying with <a href="https://pages.dev"><img alt="Cloudflare Pages" src="https://user-images.githubusercontent.com/23264/106598434-9e719e00-654f-11eb-9e59-6167043cfa01.png" width="16"></a> Cloudflare Pages
            <table>
              <tr>
                <td><strong>Latest commit:</strong></td>
                <td><code>${{ github.event.pull_request.head.sha }}</code></td>
              </tr>
              <tr>
                <td><strong>Status:</strong></td><td>‚è≥ In progress</td>
              </tr>
            </table>
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Node.js 18
        uses: actions/setup-node@v3.5.0
        with:
          node-version: '18.x'
          cache: yarn
      - run: yarn install --frozen-lockfile
      - run: yarn build-preview
      - name: Publish to Cloudflare Pages
        # Id is needed to access output in a next step
        id: cloudflare
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFRONT_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFRONT_ACCOUNT_ID }}
          # Project name created via CloudFlare dashboard
          projectName: explorer
          directory: build
      # On a subsequent run the the original comment will be updated.
      - name: Add Comment to PR
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ## Deploying with <a href="https://pages.dev"><img alt="Cloudflare Pages" src="https://user-images.githubusercontent.com/23264/106598434-9e719e00-654f-11eb-9e59-6167043cfa01.png" width="16"></a> Cloudflare Pages
            <table>
              <tr>
                <td><strong>Latest commit:</strong></td>
                <td><code>${{ github.event.pull_request.head.sha }}</code></td>
              </tr>
              <tr>
                <td><strong>Status:</strong></td><td>‚úÖ Deploy successful!</td>
              </tr>
              <tr>
                <td><strong>Preview URL:</strong></td>
                <td><a href="${{ steps.cloudflare.outputs.url }}">${{ steps.cloudflare.outputs.url }}</a></td>
               </tr>
            </table>
      - name: The job has failed
        if: ${{ failure() }}
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ## Deploying with <a href="https://pages.dev"><img alt="Cloudflare Pages" src="https://user-images.githubusercontent.com/23264/106598434-9e719e00-654f-11eb-9e59-6167043cfa01.png" width="16"></a> Cloudflare Pages
            <table>
              <tr>
                <td><strong>Latest commit:</strong></td>
                <td><code>${{ github.event.pull_request.head.sha }}</code></td>
              </tr>
              <tr>
                <td><strong>Status:</strong></td><td>üö´ Deploy failed!</td>
              </tr>
            </table>
